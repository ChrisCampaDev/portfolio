---
import En from "@/components/icons/flags/en.astro";
import Es from "@/components/icons/flags/es.astro";
import IconSun from "@/components/icons/themes/IconSun.astro";
import IconMoon from "@/components/icons/themes/IconMoon.astro";
import { Switch } from "@/components/starwind/switch";
import { getTexts, getLocaleFromAstro } from "@/utils/i18n";

const texts = getTexts(Astro);
const currentLocale = getLocaleFromAstro(Astro);
const isEnglish = currentLocale === 'en';

// Generate URLs for language switching
const currentPath = Astro.url.pathname;
const isEnglishPath = currentPath.includes('/en/');
const pathWithoutLocale = currentPath.replace(/^\/portfolio\/?(en\/?)?/, '');
const baseUrl = pathWithoutLocale || '';
const spanishUrl = `/portfolio${baseUrl ? '/' + baseUrl : ''}`;
const englishUrl = `/portfolio/en${baseUrl ? '/' + baseUrl : ''}`;
---

<nav
	class="dark:bg-black/90 bg-white/90 w-full z-20 start-0 border-b border-default top-0 sticky shadow-2xl shadow-gray-600 dark:shadow-blue-600"
>
	<div
		class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-2"
	>
		<a
			href={isEnglish ? englishUrl : spanishUrl}
			class="flex items-center space-x-3 rtl:space-x-reverse"
		>
			<span>ChrisCampaDev</span>
		</a>
		
		<!-- Navigation Links -->
		<div class="hidden md:flex items-center space-x-6">
			<a 
				href={`${isEnglish ? englishUrl : spanishUrl}#about`}
				class="text-body hover:text-fg-brand transition-colors"
			>
				{texts.nav.about}
			</a>
			<a 
				href={`${isEnglish ? englishUrl : spanishUrl}#skills`}
				class="text-body hover:text-fg-brand transition-colors"
			>
				{texts.nav.projects}
			</a>
			<a 
				href={`${isEnglish ? englishUrl : spanishUrl}#contact`}
				class="text-body hover:text-fg-brand transition-colors"
			>
				{texts.nav.contact}
			</a>
		</div>
		<div class="flex items-center md:order-2 space-x-2 rtl:space-x-reverse">
			<!-- Language Switch -->
			<a 
				href={isEnglish ? spanishUrl : englishUrl}
				class="text-body hover:bg-neutral-secondary-soft focus:outline-none focus:ring-4 focus:ring-neutral-tertiary rounded-lg text-sm p-2.5 transition-colors"
				title={texts.nav.switch}
			>
				<Es class={`w-6 h-6 ${isEnglish ? '' : 'hidden'}`} title="Español" />
				<En class={`w-6 h-6 ${isEnglish ? 'hidden' : ''}`} title="English" />
			</a>
			
			<!-- Theme Toggle -->
			<span
				class="text-body hover:bg-neutral-secondary-soft focus:outline-none focus:ring-4 focus:ring-neutral-tertiary rounded-lg text-sm p-2.5"
			>
				<IconSun id="theme-toggle-light-icon" class="w-6 h-6" />
				<IconMoon id="theme-toggle-dark-icon" class="w-6 h-6 hidden" />
			</span>
			<Switch id="theme-toggle" variant="primary" />
		</div>
	</div>
</nav>

<script is:inline>
	const themeToggleBtn = document.getElementById("theme-toggle");
	const themeToggleDarkIcon = document.getElementById("theme-toggle-dark-icon");
	const themeToggleLightIcon = document.getElementById(
		"theme-toggle-light-icon"
	);

	// Function to set theme
	const setTheme = isDark => {
		if (isDark) {
			document.documentElement.classList.add("dark");
			themeToggleLightIcon.classList.add("hidden");
			themeToggleDarkIcon.classList.remove("hidden");
			localStorage.setItem("theme", "dark");
		} else {
			document.documentElement.classList.remove("dark");
			themeToggleLightIcon.classList.remove("hidden");
			themeToggleDarkIcon.classList.add("hidden");
			localStorage.setItem("theme", "light");
		}
	};

	// Initial theme check
	const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
	const savedTheme = localStorage.getItem("theme");

	setTheme(savedTheme === "dark" || (savedTheme === null && prefersDark));

	// Example of how to toggle the theme manually
	function toggleTheme(newTheme) {
		if (newTheme === "dark") {
			document.documentElement.classList.add("dark");
		} else if (newTheme === "light") {
			document.documentElement.classList.remove("dark");
		} else if (newTheme === "system") {
			const prefersDark = window.matchMedia(
				"(prefers-color-scheme: dark)"
			).matches;
			document.documentElement.classList.toggle("dark", prefersDark);
		}

		localStorage.setItem("colorTheme", newTheme);
	}

	// Add click listener
	themeToggleBtn.addEventListener("click", function () {
		setTheme(!document.documentElement.classList.contains("dark"));
		// toggleTheme(savedTheme);
	});

	// Language switching enhancement
	const currentPath = window.location.pathname;
	const isEnglishPage = currentPath.includes('/en/') || currentPath.endsWith('/en');
	
	// Store user's language preference
	const langLinks = document.querySelectorAll('a[title*="Español"], a[title*="English"]');
	langLinks.forEach(link => {
		link.addEventListener('click', function(e) {
			const href = this.getAttribute('href');
			if (href) {
				localStorage.setItem('preferredLanguage', href.includes('/en/') ? 'en' : 'es');
			}
		});
	});
</script>
