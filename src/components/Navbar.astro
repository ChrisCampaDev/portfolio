---
import { getTexts, getLocaleFromAstro } from "@/utils/i18n";
import EsFlag from '@/components/ui/icons/flags/es.astro';
import EnFlag from '@/components/ui/icons/flags/en.astro';

// Determine current locale from the pathname considering the configured base (e.g., "/portfolio")
const { pathname, hash } = Astro.url;

const currentLocale = getLocaleFromAstro(Astro);
const isEN = currentLocale === 'en';
const t = getTexts(Astro);

// Build a switch URL that preserves the current page path and hash
function buildSwitchHref(targetLocale: 'es' | 'en') {
  const segs = pathname.split('/').filter(Boolean);
  // segs[0] is base (e.g., 'portfolio')
  const base = segs[0] ?? '';
  const hasLocale = segs[1] === 'en';
  let rest = hasLocale ? segs.slice(2) : segs.slice(1);

  let newSegs: string[];
  if (targetLocale === 'en') {
    newSegs = [base, 'en', ...rest];
  } else {
    newSegs = [base, ...rest];
  }
  const newPath = '/' + newSegs.filter(Boolean).join('/') + (pathname.endsWith('/') ? '/' : '');
  return newPath + (hash || '');
}

const switchLocale = isEN ? 'es' : 'en';
const switchHref = buildSwitchHref(switchLocale);
const switchLabel = t.nav.switch;
const TargetFlag = isEN ? EsFlag : EnFlag;
const flagTitle = switchLocale === 'es' ? 'Espa√±ol' : 'English';

---

<nav class="hidden bg-gradient-to-r from-black/40 to-transparent text-white p-5 fixed z-10 w-full lg:block">
  <div class="max-w-6xl mx-auto flex items-center justify-between">
    <ul class="flex justify-center items-center px-10 py-2 gap-10 text-lg">
      <a href="#proyectos">{t.nav.projects}</a>
      <a href="#nosotros">{t.nav.about}</a>
      <a href="#contacto">{t.nav.contact}</a>
    </ul>
    <a href={switchHref} class="px-3 py-1 rounded-md border border-white/40 hover:bg-white/10 transition inline-flex items-center gap-2" aria-label={`Switch language to ${switchLabel}`}>
      {switchLabel}
      <TargetFlag width={20} height={15} class="w-5 h-[15px]" title={flagTitle} />
    </a>
  </div>
  </nav>
